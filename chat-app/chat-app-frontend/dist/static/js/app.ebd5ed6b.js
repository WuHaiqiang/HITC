(function(){"use strict";var e={3536:function(e,t,s){var a=s(5471),r=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("router-view")],1)},n=[],i={name:"App"},o=i,c=s(1656),l=(0,c.A)(o,r,n,!1,null,null,null),u=l.exports,d=s(173),h=function(){var e=this,t=e._self._c;return t("div",{staticClass:"login-register"},[t("div",{staticClass:"login-container"},[t("h2",{staticClass:"title"},[e._v("工大聊天室")]),t("el-form",{staticClass:"login-form",attrs:{model:e.loginForm},nativeOn:{submit:function(t){return t.preventDefault(),e.handleLogin.apply(null,arguments)}}},[t("el-form-item",{attrs:{label:"用户名"}},[t("el-input",{model:{value:e.loginForm.user_name,callback:function(t){e.$set(e.loginForm,"user_name",t)},expression:"loginForm.user_name"}})],1),t("el-form-item",{attrs:{label:"密码"}},[t("el-input",{attrs:{type:"password"},model:{value:e.loginForm.password,callback:function(t){e.$set(e.loginForm,"password",t)},expression:"loginForm.password"}})],1),t("el-form-item",[t("el-button",{staticClass:"login-button",attrs:{type:"primary"},on:{click:e.handleLogin}},[e._v("登录")])],1)],1)],1)])},m=[],g=(s(4114),s(4335));const f=g.A.create({baseURL:"http://172.20.109.1:3001",timeout:1e4,headers:{"Content-Type":"application/json"}});var p=f,v={name:"LoginPage",data(){return{loginForm:{user_name:"",password:""}}},methods:{async handleLogin(){try{console.log(this.loginForm);const e=await p.post("/user/login",this.loginForm);e.data&&e.data.user_id?(localStorage.setItem("userId",e.data.user_id),this.$router.push("/main")):this.$message.error("用户名或密码错误。")}catch(e){this.$message.error(e.response?e.response.data:"登录失败。")}}}},C=v,y=(0,c.A)(C,h,m,!1,null,"1643532c",null),b=y.exports,_=function(){var e=this,t=e._self._c;return t("div",{staticClass:"main-page"},[t("el-container",[t("el-header",{staticClass:"header"},[t("div",{staticClass:"header-content"},[t("div",{staticClass:"user-info",on:{click:e.triggerFileInput}},[t("el-avatar",{staticClass:"avatar",attrs:{src:e.currentUser.avatar,size:"large"}}),t("span",{staticClass:"user_name"},[e._v(e._s(e.currentUser.user_name))]),t("input",{ref:"fileInput",staticStyle:{display:"none"},attrs:{type:"file"},on:{change:e.handleFileChange}})],1),t("span",{staticClass:"header-title"},[e._v("哈工大聊天室")]),t("el-button",{staticClass:"logout-button",attrs:{type:"danger"},on:{click:e.EXIT}},[e._v("EXIT")])],1)]),t("el-container",[t("el-aside",{staticClass:"sidebar",attrs:{width:"300px"}},[t("el-autocomplete",{attrs:{placeholder:"Search friends","fetch-suggestions":e.searchFriends,"trigger-on-focus":!1,"popper-append-to-body":"","popper-class":"autocomplete-popper",clearable:""},on:{select:e.handleSelect},scopedSlots:e._u([{key:"default",fn:function({item:s}){return[t("div",{staticClass:"name"},[e._v(e._s(s.user_name))])]}}]),model:{value:e.searchQuery,callback:function(t){e.searchQuery=t},expression:"searchQuery"}}),t("div",{staticClass:"list-container"},[t("div",{staticClass:"title"},[e._v("好友列表")]),t("el-scrollbar",{staticClass:"friend-list"},[t("el-menu",{staticClass:"el-menu-vertical-demo"},e._l(e.friends,(function(s,a){return t("el-menu-item",{key:s.id,staticClass:"friend-item",attrs:{index:a.toString()},on:{click:function(t){return e.selectFriend(s)}}},[e._v(" "+e._s(s.username)+" ")])})),1)],1)],1),t("div",{staticClass:"list-container"},[t("div",{staticClass:"title"},[e._v("好友请求")]),t("el-scrollbar",{staticClass:"request-list"},[t("el-menu",{staticClass:"el-menu-vertical-demo"},e._l(e.friendRequests,(function(s,a){return t("el-menu-item",{key:s.id,staticClass:"friend-item",attrs:{index:a.toString()}},[e._v(" "+e._s(s.senderuser_name)+" "),t("el-button",{staticStyle:{"margin-left":"30px"},attrs:{type:"success",size:"mini"},on:{click:function(t){return e.acceptFriendRequest(s.id)}}},[e._v("接受")]),t("el-button",{staticClass:"reject-button",staticStyle:{"margin-left":"5px"},attrs:{type:"danger",size:"mini"}},[e._v("拒绝")])],1)})),1)],1)],1)],1),t("el-container",{staticClass:"content"},[e.selectedFriend&&e.isFriend?t("chat-window",{attrs:{friend:e.selectedFriend,messages:e.messages,newMessage:e.newMessage,currentUser:e.currentUser},on:{"send-message":e.sendMessage,"close-chat":e.closeChat}}):e._e()],1)],1)],1),t("el-dialog",{attrs:{visible:e.dialogVisible,title:"Add Friend"},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("span",[e._v("Would you like to send a friend request to "+e._s(e.selectedFriend?.user_name)+"?")]),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v("Cancel")]),t("el-button",{attrs:{type:"primary"},on:{click:e.sendFriendRequest}},[e._v("Send")])],1)])],1)},F=[],w=function(){var e=this,t=e._self._c;return t("div",{staticClass:"chat-window"},[t("div",{staticClass:"header"},[t("span",{staticClass:"title"},[e._v(e._s(e.friend.username))]),t("el-button",{staticStyle:{"background-color":"#20C997","border-color":"#20C997",color:"#FFFFFF"},attrs:{type:"danger",size:"mini"},on:{click:e.closeChat}},[e._v(" 关闭 ")])],1),t("div",{ref:"messageContainer",staticClass:"message-container"},e._l(e.localMessages,(function(s){return t("div",{key:s.id,staticClass:"message",class:{"message-sent":s.senderId===e.currentUser.user_id,"message-received":s.senderId!==e.currentUser.user_id}},[t("div",{staticClass:"message-content"},[t("div",{staticClass:"text"},[e._v(e._s(s.content))])]),s.senderId!==e.currentUser.user_id?t("div",{staticClass:"message-avatar-left"}):t("div",{staticClass:"message-avatar-right"},[t("el-avatar",{staticClass:"avatar",attrs:{src:e.currentUser.avatar,size:"large"}})],1)])})),0),t("div",{staticClass:"chat-box"},[e._m(0),t("div",{staticClass:"message-input"},[t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.localMessage,expression:"localMessage"}],staticClass:"message-textarea",attrs:{placeholder:"Type a message"},domProps:{value:e.localMessage},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.sendMessage.apply(null,arguments)},input:function(t){t.target.composing||(e.localMessage=t.target.value)}}}),t("div",{staticClass:"buttons"},[t("button",{staticClass:"close-btn",on:{click:e.closeChat}},[e._v("关闭")]),t("button",{staticClass:"send-btn",on:{click:e.sendMessage}},[e._v("发送")])])])])])},I=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"toolbar"},[t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon smiley"})]),t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon scissors"})]),t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon folder"})]),t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon image"})]),t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon phone"})]),t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon envelope"})]),t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon microphone"})]),t("button",{staticClass:"icon-btn"},[t("i",{staticClass:"icon clock"})])])}],M={props:{friend:Object,messages:Array,currentUser:Object},data(){return{localMessage:"",localMessages:[],localcurrentUser:{user_id:null,user_name:"",avatar:""}}},watch:{messages:{handler(e){this.localMessages=[...e],this.scrollToBottom()},immediate:!0}},methods:{async fetchCurrentUser(){const e=localStorage.getItem("userId");if(e)try{const t=await g.A.get(`/user/${e}`);this.localCurrentUser=t.data;const s="http://127.0.0.1:3000/server";this.localCurrentUser.avatar=`${s}${this.localCurrentUser.avatar}`}catch(t){console.error(t),this.$message.error("Failed to fetch user information.")}else this.$router.push("/")},async sendMessage(){if(!this.localMessage.trim())return;const e={senderId:this.currentUser.user_id,receiverId:this.friend.friendId,content:this.localMessage,senderUsername:this.currentUser.user_name,messageContent:this.localMessage,senderAvatarUrl:this.currentUser.avatar};try{const t=await g.A.post("http://localhost:3001/user/sendMessage",e);this.localMessages.push({...e,id:t.data.id,timestamp:(new Date).toISOString()}),this.localMessage="",this.scrollToBottom()}catch(t){console.error("Error sending message:",t)}},closeChat(){this.$emit("close-chat")},scrollToBottom(){this.$nextTick((()=>{const e=this.$refs.messageContainer;e.scrollTop=e.scrollHeight}))}}},k=M,U=(0,c.A)(k,w,I,!1,null,"6a509f36",null),$=U.exports,S={name:"MainPage",components:{ChatWindow:$},data(){return{searchQuery:"",friends:[],friendRequests:[],selectedFriend:null,messages:[],newMessage:"",currentUser:{},isFriend:!1,dialogVisible:!1}},async created(){await this.fetchCurrentUser(),await this.fetchFriends(),await this.fetchFriendRequests()},methods:{async fetchCurrentUser(){const e=localStorage.getItem("userId");if(e)try{const t=await p.get(`/user/${e}`);this.currentUser=t.data;const s="http://127.0.0.1:3000/server";this.currentUser.avatar=`${s}${this.currentUser.avatar}`}catch(t){console.error(t),this.$message.error("Failed to fetch user information.")}else this.$router.push("/")},async fetchFriends(){try{const e=localStorage.getItem("userId"),t=await p.get(`/user/friends/${e}`);this.friends=t.data.filter((e=>e.id!==this.currentUser.user_id)).map((e=>(console.log("sssssssssssss"),console.log(t.data),console.log("sssssssssssss"),console.log(e),e)))}catch(e){console.error(e)}},async fetchFriendRequests(){try{const e=localStorage.getItem("userId"),t=await p.get(`/user/friendRequests?userId=${e}`);this.friendRequests=t.data.map((e=>(e.avatar=`http://localhost:3001${e.avatar}`,e)))}catch(e){console.error(e)}},triggerFileInput(){this.$refs.fileInput.click()},handleFileChange(e){const t=e.target.files[0];t&&this.uploadAvatar(t)},async uploadAvatar(e){const t=localStorage.getItem("userId"),s=new FormData;s.append("avatar",e);try{const e=await p.post(`http://localhost:3001/user/uploadAvatar/${t}`,s,{headers:{"Content-Type":"multipart/form-data"}});this.currentUser.avatar=`http://localhost:3001${e.data.avatar}`}catch(a){console.error(a),this.$message.error("Failed to upload avatar.")}},async searchFriends(e,t){try{const s=await p.get("/user/search",{params:{user_name:e}}),a=s.data.filter((e=>e.user_id!==this.currentUser.user_id)).map((e=>(e.avatar=`http://localhost:3001${e.avatar}`,e)));t(a.map((e=>({value:e.user_name,...e}))))}catch(s){console.error(s),t([])}},handleSelect(e){const t=this.friends.some((t=>t.username===e.user_name));if(t){const t=this.friends.find((t=>t.username===e.user_name));this.selectFriend(t)}else this.selectedFriend=e,this.isFriend=!1,this.dialogVisible=!0;this.searchQuery=""},async selectFriend(e){this.isFriend=this.friends.some((t=>t.id===e.id)),this.isFriend?(this.selectedFriend=e,await this.fetchMessages(e.friendId)):(this.selectedFriend=null,this.dialogVisible=!0)},async fetchMessages(e){try{const t=await p.get("/user/messages",{params:{userId1:this.currentUser.user_id,userId2:e}});this.messages=t.data}catch(t){console.error(t)}},async sendMessage(){if(this.newMessage&&this.selectedFriend)try{const e=await p.post("/user/sendMessage",{senderId:this.currentUser.user_id,receiverId:this.selectedFriend.friendId,content:this.newMessage});this.messages.push(e.data),this.newMessage=""}catch(e){console.error(e)}},closeChat(){this.selectedFriend=null},async sendFriendRequest(){try{const e=await p.post("/user/sendFriendRequest",{senderId:this.currentUser.user_id,receiverId:this.selectedFriend.user_id});this.dialogVisible=!1,this.$message.success(e.data)}catch(e){console.error(e),this.$message.error("Failed to send friend request.")}},async acceptFriendRequest(e){try{const t=await p.post("/user/acceptFriendRequest",{requestId:e});this.$message.success(t.data),await this.fetchFriendRequests(),await this.fetchFriends()}catch(t){console.error(t)}},EXIT(){localStorage.removeItem("userId"),this.$router.push("/")}}},x=S,O=(0,c.A)(x,_,F,!1,null,"06ae41d1",null),q=O.exports;a["default"].use(d.A);var A=new d.A({mode:"hash",base:"",routes:[{path:"/",name:"Login",component:b},{path:"/main",name:"MainPage",component:q}]}),T=s(1052),R=s.n(T);a["default"].config.productionTip=!1,a["default"].use(R()),new a["default"]({router:A,render:e=>e(u)}).$mount("#app")}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var n=t[a]={id:a,loaded:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.loaded=!0,n.exports}s.m=e,function(){s.amdO={}}(),function(){var e=[];s.O=function(t,a,r,n){if(!a){var i=1/0;for(u=0;u<e.length;u++){a=e[u][0],r=e[u][1],n=e[u][2];for(var o=!0,c=0;c<a.length;c++)(!1&n||i>=n)&&Object.keys(s.O).every((function(e){return s.O[e](a[c])}))?a.splice(c--,1):(o=!1,n<i&&(i=n));if(o){e.splice(u--,1);var l=r();void 0!==l&&(t=l)}}return t}n=n||0;for(var u=e.length;u>0&&e[u-1][2]>n;u--)e[u]=e[u-1];e[u]=[a,r,n]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){s.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={524:0};s.O.j=function(t){return 0===e[t]};var t=function(t,a){var r,n,i=a[0],o=a[1],c=a[2],l=0;if(i.some((function(t){return 0!==e[t]}))){for(r in o)s.o(o,r)&&(s.m[r]=o[r]);if(c)var u=c(s)}for(t&&t(a);l<i.length;l++)n=i[l],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(u)},a=self["webpackChunkchat"]=self["webpackChunkchat"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=s.O(void 0,[504],(function(){return s(3536)}));a=s.O(a)})();
//# sourceMappingURL=app.ebd5ed6b.js.map